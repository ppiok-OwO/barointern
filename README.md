## Contents
1. [í”„ë¡œì íŠ¸ ì†Œê°œ](#-í”„ë¡œì íŠ¸-ì†Œê°œ)
2. [í”Œë¡œìš° ì°¨íŠ¸](#-í”Œë¡œìš°-ì°¨íŠ¸)
3. [ERD](#-ERD)
4. [ì‹¤í–‰ ë°©ë²•](#-ì‹¤í–‰-ë°©ë²•)

# í”„ë¡œì íŠ¸ ì†Œê°œ
[í˜ë‚´ë¼ğŸ’ª í´ë¦­ ëŒ€íšŒ!]
### **(1) ì´ë²¤íŠ¸ ê°œìš”**

HHì‹œ 00ë¶„ ë¶€í„° **1ë¶„ ê°„** â­íšŒì‚¬ì˜ ëŒ€í‘œ ë§ˆìŠ¤ì½”íŠ¸ì¸ ğŸ˜¡(ì‹¬ìˆ ì´)ë¥¼ ê°€ì¥ ë§ì´ í´ë¦­í•œ ì‚¬ìš©ì ê²½í’ˆ ë°œì†¡ ì´ë²¤íŠ¸

### **(2) ì´ë²¤íŠ¸ ì°¸ì—¬ ê·œì¹™**

1. â€œ1ë¶„â€ì€ 00ì´ˆë¶€í„° 59.999999ì´ˆë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì‹œê°„ ë²”ìœ„ì— ë“¤ì–´ì˜¤ì§€ ì•Šì€ í´ë¦­ì€ ì„¸ì§€ ë§ì•„ì•¼í•©ë‹ˆë‹¤.
2. ì–´ë– í•œ ì—°ì†ëœ 1ì´ˆ êµ¬ê°„ ë‚´ì— í´ë¦­ íšŸìˆ˜ê°€ 4íšŒë¥¼ ì´ˆê³¼í•˜ë©´ ì‹¤ê²© ì²˜ë¦¬ë©ë‹ˆë‹¤. ì´ˆë‹¹ 4íšŒë¥¼ ì´ˆê³¼ì‹œ ë¶€ì •í–‰ìœ„ìë¡œ ê°„ì£¼í•˜ê³  ëˆ„ì  í´ë¦­ëŸ‰ì— ê´€ê³„ ì—†ì´ ì‹¤ê²© ì²˜ë¦¬ ë©ë‹ˆë‹¤.
3. íšŒì›ê°€ì…í•˜ì§€ ì•Šì€ ìœ ì €ëŠ” ì°¸ì—¬ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
4. ì²« í´ë¦­ì€ ì°¸ì—¬ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
5. ì°¸ì—¬í•œ ìœ ì €ê°€ 10ì´ˆê°„ í´ë¦­í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ìë™ ì‹¤ê²© ì²˜ë¦¬ë©ë‹ˆë‹¤. ì¦‰, ì´í›„ì˜ ìš”ì²­ì„ ì„¸ì§€ ë§ì•„ì•¼í•©ë‹ˆë‹¤.
6. ê°ì¢… ì‚¬ìœ ë¡œ ì‹¤ê²©í•œ ì°¸ì—¬ìëŠ” ì¬ì°¸ì—¬ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
7. ê²½í’ˆì´ ë¹„ì‹¸ê¸° ë•Œë¬¸ì— ë³µìˆ˜ì˜ ìœ ì €ê°€ ìš°ìŠ¹ìê°€ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í´ë¦­ìˆ˜ê°€ ë™ì¼í•œ ì„ ë‘ê°€ ìƒê¸¸ ê²½ìš°, 1 ë§ˆì´í¬ë¡œì´ˆë¼ë„ ë¹ ë¥´ê²Œ í´ë¦­ìˆ˜ì— ë„ë‹¬í•œ ìœ ì €ê°€ ìš°ìŠ¹ìê°€ ë©ë‹ˆë‹¤.

# í”Œë¡œìš° ì°¨íŠ¸
![image](https://github.com/user-attachments/assets/040f146d-a280-4b7a-802b-b5204fa81ad2)

# ERD
![image](https://github.com/user-attachments/assets/e29a77fb-377f-4f68-845e-f976bd9e981b)

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•
## e2e í…ŒìŠ¤íŠ¸
ì½˜ì†” ì°½ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.(bash)
```bash
chmod +x run-all.sh
./run-all.sh
```
## ìœ ë‹› í…ŒìŠ¤íŠ¸
ì½˜ì†” ì°½ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.(powershell)
```powershell
node test/unit/unit.test.js
```

# ì„¸ë¶€ ì½”ë“œ ì„¤ëª…
ë³¸ í”„ë¡œì íŠ¸ëŠ” HTTP ì„œë²„ë¡œ êµ¬í˜„ëœ ë¡œê·¸ì¸ ì„œë²„ì™€ TCP ì„œë²„ë¡œ ë‚˜ë‰˜ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.

## src/loginServer/loginServer.js
```JS
import http from "node:http";
import { config } from "../config/config.js";
import { requestListener } from "./requestListener.js";

const PORT = config.LOGIN_SERVER_PORT;

const server = http.createServer(requestListener);
server.listen(PORT);
```
ë¡œê·¸ì¸ ì„œë²„ëŠ” http ë‚´ì¥ ëª¨ë“ˆë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, 3000ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

## src/index.js ì™€ src/server.js
```js
import cluster from "node:cluster";
import os from "node:os";
import {
  scheduleEventStart,
  triggerEventManually,
} from "./events/eventController.js";
import { evaluateWinner } from "./utils/evaluator.js";

const results = [];

if (cluster.isPrimary) {
  const numCPUs = os.cpus().length;

  // ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìƒì„±
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }

  for (const id in cluster.workers) {
    const worker = cluster.workers[id];

    worker.on("message", (msg) => {
      if (msg.type === "EVENT_RESULT") {
        console.log(
          `[MASTER] ê²°ê³¼ ìˆ˜ì‹  from ${msg.from}, count=${msg.data.length}`
        );
        results.push(...msg.data);
      }
    });
  }

  // í…ŒìŠ¤íŠ¸ í™˜ê²½: MANUAL=true ì„¤ì • ì‹œ ì¦‰ì‹œ ì´ë²¤íŠ¸ ì‹œì‘
  if (process.env.MANUAL === "true") {
    setTimeout(() => {
      triggerEventManually((eventType) => {
        for (const id in cluster.workers) {
          cluster.workers[id].send({ type: eventType });
        }

        if (eventType === "EVENT_END") {
          setTimeout(() => {
            console.log("[MASTER] ìš°ìŠ¹ì í‰ê°€ ì‹œì‘");
            evaluateWinner(results);
          }, 1000);
        }
      });
    }, 1000); // ì„œë²„ ì¤€ë¹„ ì‹œê°„ í™•ë³´
  } else {
    // ì‹¤ì„œë¹„ìŠ¤ìš©: ì •ì‹œ ì˜ˆì•½ ì´ë²¤íŠ¸ ì‹œì‘
    scheduleEventStart((eventType) => {
      for (const id in cluster.workers) {
        cluster.workers[id].send({ type: eventType });
      }

      if (eventType === "EVENT_END") {
        setTimeout(() => {
          console.log("[MASTER] ìš°ìŠ¹ì í‰ê°€ ì‹œì‘");
          evaluateWinner(results);
        }, 1000);
      }
    });
  }
} else {
  import("./server.js");
}
```
TCP ì„œë²„ëŠ” cluster ë‚´ì¥ ëª¨ë“ˆì„ í†µí•´ CPU ê°œìˆ˜ë§Œí¼ Worker ë¶„ì‚° ìƒì„±í•©ë‹ˆë‹¤.<br>
scheduleEventStartë¡œ ë§¤ì‹œ ì •ê° ì´ë²¤íŠ¸ ì‹œì‘í•©ë‹ˆë‹¤.<br>
1ë¶„ í›„ ìë™ ì¢…ë£Œí•˜ê³ , ìš°ìŠ¹ìë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>

```js
process.on("message", (msg) => {
  if (msg.type === "EVENT_START") {
    customers.eventStart();
  } else if (msg.type === "EVENT_END") {
    customers.eventEnd();

    const all = customers.getCustomers();
    const summary = [];

    for (const [email, user] of all.entries()) {
      summary.push({
        email,
        clickCount: user.lastClicks.length,
        lastClick: Math.max(...user.lastClicks, 0),
        disqualified: user.disqualified,
      });
    }

    process.send?.({
      type: "EVENT_RESULT",
      from: process.pid,
      data: summary,
    });
  }
});
```
ê° ì›Œì»¤ì—ì„œëŠ” ë§ˆìŠ¤í„° ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê³ , ìœ ì € ìƒíƒœë¥¼ ë°°ì—´ í˜•íƒœë¡œ íšŒì‹ í•©ë‹ˆë‹¤.<br>

```js
if (!customers.eventActive) return;
const customer = customerList.get(email);
if (customer.disqualified) return;

const now = Date.now();
customer.lastClicks.push(now);
customer.lastActive = now;

if (isSlidingWindowViolated(customer.lastClicks)) {
  customer.disqualified = true;
  console.log(`[DISQUALIFIED] ${email} - í´ë¦­ ê³¼ë‹¤`);

  const stmt = db.prepare(
    "UPDATE Customers SET retryable = 0 WHERE email = ?"
  );
  stmt.run(email);

  socket.end();
}
```
í•œí¸ net ëª¨ë“ˆë¡œ ìƒì„±ëœ ì†Œì¼“ì—ì„œëŠ” onData ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.<br>
ë§Œì•½ ìˆ˜ì‹ í•œ ë°ì´í„°ê°€ ì´ë©”ì¼ì´ë¼ë©´,<br>
emailì„ keyë¡œ ê°€ì§€ê³  í´ë¦­ì— ëŒ€í•œ ê¸°ë¡ì„ valueë¡œ ì €ì¥í•˜ëŠ” Map ìë£Œêµ¬ì¡°ë¥¼<br>
Customers í´ë˜ìŠ¤ ë‚´ë¶€ì— ìƒì„±í•©ë‹ˆë‹¤.<br>
ì´ë©”ì¼ì´ ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´ ë°ì´í„°ë¥¼ ìˆ˜ì‹ ë°›ì€ ì‹œê°ì„ customer.lastClicks ë°°ì—´ì— ê¸°ë¡í•©ë‹ˆë‹¤.<br>

# ê¸°ìˆ  ìŠ¤íƒ
Node.js v22.14.0<br>
HTTP ì„œë²„: node:http<br>
TCP ì„œë²„: node:net<br>
ë©€í‹°ì½”ì–´ ë³‘ë ¬ ì²˜ë¦¬: node:cluster<br>
DB: node:sqlite<br>
